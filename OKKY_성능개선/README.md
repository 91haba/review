# OKKY 성능 개선

## 1. 성능 고려 개발 -> 출시

### APP

* 안드로이드는 싱글 쓰레드가 렌더링을 담당
* 메인 쓰레드 점유율 시간을 최대한 짧게 해서 API 통신 결과를 받고 난뒤 렌더링 되는 속도를 최대한 개선
  * 60 FPS
  * 16 MS

### 퍼포먼스 테스트

* 사용자 천만 / 메세지 일 1억건
  * 초당 메세지수는 트래픽 형태 기반으로 추정
  * 로그인을 아침에, 로그아웃을 밤에 한다는 것을 확인
  * 초당 메세지 최대치를 1만이상으로 산정
* 버츄얼 박스로 로컬에 서버 구동
  * 리눅스 서버 몇개를 올린 뒤 스트레스 테스트용 클라이언트 개발
* 임계점
  * 서버가 처리할 수 있는 양이 있는데, 이걸 초과하는 요청이 오면 대기열이 발생
  * 대기열이 발생하는 지점
  * 임계점 확인이 필요
* 정리
  * 성능
      * TPS
      * Response mean time
      * 임계점
  * 개발
      * API: 네트워크, 프로토콜

## 2. 출시 -> 성능개선

* 고객이 0명인데 성능이 중요한가?
* 이미 AWS가 나온 상황에서 하나하나 모든 계층의 성능 최적화를 당장 할 필요가 있을까?
  * 가성비가 너무 떨어짐
  * 가성비가 단지 하드웨어 성능만을 이야기 하지 않음
* 오토스케일링이 되면 임계점이 없어지는건가?
  * RDS의 임계점은?
* AWS 아키텍처의 베스트 프렉티스를 따르는게 진짜 가성비가 좋은걸까?
  * 닭잡을 일에 소잡는 칼을 쓰는 격이 될수도 있다는 생각이 듬

### [True Balance](http://truebalance.io/)

* 인도 5천만 다운로드
* AWS, MSA -> IDC
  * 인도 규제로 인도 IDC로 이전하게 됨
* 출시 -> 서비스 성장 -> 모니터링 -> 성능개선
* 아키텍처
  * MSA
  * 오래 걸리는 일은 SQS 로 비동기 워커 처리
* MSA
  * 모노릭스로 구성했던 과거를 떠올려 보면 서로 다른 기능을 가진 프로젝트가 한 서버에 있으니, 한쪽 기능이 성능을 많이 잡아먹으면 스케일 아웃을 바로 해야했었음
  * MSA로 구현후, 각 도메인별 TF 구성이 가능하는 등 **조직의 속도가 빨라짐**
  * 단, 모노릭스에서 MSA로 전환하는 과정이 순탄하진 않았음
  * 각각의 전문화/분업화가 되다보니 **전체를 보는 곳이 사라짐**

### 모니터링 & 발견

* 서버
  * MSA로 서비스와 팀을 분리
  * 금융과 관계되다보니 규제와 정책상 인프라팀을 제외한 개발직군은 인프라 영역에 대한 접근성이 멀어지게 됨
  * 직접 접근하지 않고, 모니터링을 할 수 있도록 APM 도입
      * 와탭: 개발팀에서 사용
      * 핀포인트: 인프라팀이 시스템 전체를 보기 위해 사용
  * APM을 통해 사전에 재앙을 탐지 가능
* APP
  * APP 모니터링을 위해 모니터링 환경 직접 구축
  * 클라가 생성하는 모든 로그를 응답 없이 스트리밍으로 수신
  * Kinesis / 병렬 DB 등으로 구축
* 인도 통신사 환경상 통신사 API는 2초 ~ 60초까지 응답 타입이 제각각
  * UI에선 동기적으로 보이지만, 서버에서 비동기로 처리
  * UI에선 짧은 주기로 성공했는지 안했는지 확인
  * 앱에서 측정되는 성능을 기반으로 사용자 경험이 개선되었는지 확인
  * 요청 하나에 SQL이 얼마나 발생했는지, 총 시간이 얼마나 걸렸는지 등등을 모두 확인

### 분석

* 로그는 Elasticsearch에 모아 Kibana로 시각화
* 제일 앞단 게이트웨이에서 매 요청마다 헤더에 유니크 키 값을 두고 이를 뒤 요청시에도 계속 달고 가도록 함

### 테스트

* 스트레스 테스트
  * [LOCUST](https://locust.io/)
